<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<link REL="SHORTCUT ICON" HREF="img/favicon.ico">
		<title>Agility game</title>
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script src="lib/papaparse.min.js"></script>
	</head>
	<style>
		 body { 			font-family:SegoeUI,Verdana,Geneva,sans-serif; font-size:16px; box-sizing:border-box; 
							padding:0; margin:0; position:fixed; width:100%; 
							}
		.lz-splash { 		color:#999; text-align:center; margin-top:10%; display:none;
							}
		.lz-main { 			width:100%; height:var(--maxvh);  user-select: none; display:none;
							}
		.lz-if { 			position:absolute; top:24px; left:calc(12.5% + 24px); font-size:1.8vw; color:#27ae60; font-weight:bold;
							}
		.lz-infield { 		position:absolute; top:11vw; left:calc(12.5% + 24px); width:calc(75vw - 60px); height:calc(var(--maxvh) - 11vw - 12px); text-align:left; 
							}
		.lz-flow { 			position:absolute; display:table; top:0; left:0; height:100%; width:calc(12.5% ); 
							text-align:right;
							}
		.lz-tip { 			position:absolute; top:-5.5vw; left:0; font-size:2vh; font-style:italic;
							}
		.lz-dialog {		position:absolute; top:16px; left:16px; background-color: #eee; border: 1px solid #aaa;
							padding:16px; border-radius: 16px; width: 600px;
							}
		.lz-card {			position:absolute;	background-color:#fff; border:2px solid #999; border-radius:6px; overflow:hidden;
							display:grid;align-items:start;  grid-template-rows: 1fr 2fr 2fr 8fr 1fr;
							grid-template-areas:'category category category category' 'title title pic time' 
							'subtitle subtitle subtitle subtitle' 'desc desc desc desc''students students students students';
							}
		.lz-tab {			width:100px; cursor:pointer; font-size:13px; padding:4px 0; border:1px solid #999;
							border-radius:6px; margin-right:6px; border-bottom-left-radius:0; border-bottom-right-radius:0;
							font-style:normal; background-color:#fff; display:inline-block; text-align:center; border-bottom:none;
							}
		.lz-hover:hover {	transform:scale(3); z-index:100; 
							}
		.lz-confirm {		position:absolute;  width:300px; padding: 16px; left:calc(50% - 150px); top:calc(50vh - 50px); user-select: none;	
							border-radius: 8px; background-color: #fff; border: 1px solid #999; box-shadow: 4px 2px 12px 2px #aaa; 
							}
		.lz-popup {			position:absolute;  width: auto; max-width:200px; padding: 12px; left: calc(50% - 100px); top: calc(66% - 50px);
							border-radius: 8px; background-color: #eee; border: 1px solid #999; box-shadow: 4px 2px 12px 2px #aaa; 
							font-size: 14px; text-align:center; display:none;
			}
		.lz-is {			border-radius:16px; padding:0 8px; width:250px; height: 24px;
							border:1px solid #999; font-size: 13px;
							}
		.lz-bs {			cursor: pointer; color:#fff; text-align: center; border-radius: 16px; display: inline-block;
							font-size: 16px; background-color: #27ae60; padding: 4px 12px 4px 12px; vertical-align:3px;user-select: none;
							} 

		:root  {			--maxvh: 100vh  }
		table  {			border-spacing: 0px;  }
		@font-face {  		font-family: SegoeUI; src: url(img/segoeui.ttf);   }

		body ::-webkit-scrollbar { width: 9px; height:8px } 
		body ::-webkit-scrollbar-track { background: transparent; }
		body ::-webkit-scrollbar-thumb { border-radius:8px ;background:#a4baec }
		body ::-webkit-scrollbar-thumb:hover { background: #a4baec }

</style>
	<body>
		<div class="lz-main" id="mainDiv">
			<div id="lz-students"></div>
			<div id="lz-flowDiv" class="lz-flow"></div>
			<div id="lz-ifDiv" class="lz-if"></div>
			<div id="lz-infieldDiv" class="lz-infield"></div>
			<img src="img/smlogo.png" style="position:absolute;left:56px;bottom:12px;width:68px">
		</div>
			<div id="splashDiv" class="lz-splash">
			<img src="img/ACTlogo.png" style='width:200px' alt="logo"><br>
			<br><p style="color:#000;font-size:14px"><em>A game to practice teaching techniques</em></p>
			<br><p style="color:#000;font-size:14px"><b>Please type in your first name below</b></p>
			<p></p><input class='lz-is'  type='text' id='lz-login'></p>
			<br><br><br><br><div style="font-size:11px">&copy; 2022 StageTools </div>
		</div>
	
<script>

/////////////////////////////////////////////////////////////////////////////////////////////////
// MAIN   node ../agileSQL/sql.js
/////////////////////////////////////////////////////////////////////////////////////////////////

	var app=null;																					// Holds app
	var isMobile=false;																				// Mobile?



	$(document).ready(function() {								           							// ON PAGE LOADED
		app=new App();																				// Load app
		if (window.location.host != "localhost") 													// Not in debug
			$("#splashDiv").fadeIn(2000);															// Fade in splash page
		else{																						// Debug
			$("#mainDiv").fadeIn(0);																// Load fast
			app.LoadConfig();																		// Load config to start round	
			}
	
		$("#lz-login").on("change",()=> { 															// ON LOG IN
			app.me=$("#lz-login").val().trim();														// Set player name
			$("#splashDiv").fadeOut();																// Fade out splash
			$("#mainDiv").fadeIn(2000);																// Fade in main
			app.LoadConfig();																		// Load config to start round	
			});

		$("#lz-ifDiv").on("click",(e)=> { 															// ON LOG IN
			if (e.ctrlKey && e.ctrlKey) {															// If keys pressed
				Sound("ding");																		// Ding
				app.GetAll();																		// Save DB to CSV
				}
			});

		$(window).on("keydown",function(e) {														// HANDLE KEYPRESS
			if ((e.which == 81) && e.ctrlKey)	{													// Test key (CTL-Q)
					}
			});
		});

	$(window).on("resize orientationchange", ()=>{                                       		 // ON WINDOW RESIZE
		document.documentElement.style.setProperty("--maxvh", window.innerHeight+"px");				// Set CSS var for IOS 100vh isssue
		app.Draw(true);																				// Redraw to fit screen
		let wid=$(window).width()*50/100;															// Set width
		$("#lz-videoChat").css({ height:wid*.5625+"px",width:wid+"px" });							// Resize video if open
		});

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// APP
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class App  {																					

	constructor()   																				// CONSTRUCTOR
	{
		app=this;
		this.me="Bill";																					// Player's first name
		this.curPlayer=0;																				// Player id
		this.glassTimer=null;																			// Hourglass timer
		this.gs={};																						// Holds game state
		this.ifs=[];																					// Holds ifs
		this.thens=[];																					// Holds thens
		this.outcomes=[];																				// Holds outcomes
		this.strings=[];																				// Holds strings
		this.flow=[];																					// Holds flow
		this.stuCols=["#b0263e","#256caa","#ea7f1d","#9c25aa","#25aa54"]								// Student colors
		this.id="";																						// Set in InitSocket()
		this.time=(window.location.host == "localhost") ? 5 : 30;										// Time in seconds
		this.speed=2;																					// Speed multiplier = 2 1
		this.start=1;																					// Starting phase 1
		this.round=0;																					// Round number
	}

	LoadConfig()																					// LOAD CONFIG FILE
	{	
		let i;
		fetch('data/config.csv')																		// Load file
			.then(res => res.text())																	// Get as text
			.then(res =>{																				// Process																	
				let d=Papa.parse(res, { header:true, skipEmptyLines:true }).data;						// Parse CSV using papa lib
				for (i=0;i<d.length;++i) {																// For each line
					if (d[i].type == "if")				this.ifs.push(d[i].title);						// Add if
					else if (d[i].type == "then") {														// Add then	
						d[i].time=JSON.parse(d[i].time);												// Objectify					
						this.thens.push(d[i]);															// Add																
						}
					else if (d[i].type == "string")		this.strings[d[i].category]=d[i].title;			// Add string										
					else if (d[i].type == "phase")		this.flow.push(d[i]);							// Add flow										
					else if (d[i].type == "outcome")	this.outcomes.push(d[i]);						// Add outcome										
					}
				this.InitSocketServer();																// Start socket server
				this.Draw();																			// Draw screen
			})
	}

	Save() 																							// SAVE DATA
	{
		this.gs.round=this.round;
		fetch(`//${window.location.host}:8081?q=save&email=${app.id}&type=AG`,							// Save to DB
			{ method:"POST", "Content-Type":"application/json", body:JSON.stringify(app.gs)})
				.then(res => res.text())																// Get as text
				.then(text =>{																			// Process																	
				})		
		}

	GetAll()
	{
		fetch(`//${window.location.host}:8081?q=loadall&a=b&type=AG`)
					.then(res => res.json())															// Get as text
					.then(data =>{																		// Process
						let str=Papa.unparse(data,{ header:true, skipEmptyLines:true, });				// Make CSV using lib
						SaveTextAsFile("AGDatabase.csv", str);											// Save to file
					})		
	}

/////////////////////////////////////////////////////////////////////////////////////////////////
// ACT 
/////////////////////////////////////////////////////////////////////////////////////////////////

	SetPhase(phase, redraw)																			// SET PHASE OF GAME
	{
		if (phase == 1) {																				// START 
			this.start=0; 																				// Out of start sequence
			Sound("ding");																				// Ding
			this.HourGlassTimer(this.time, ()=>{ Sound("clicks"); $("#lz-topbut").css("background-color","#27ae60"); });	// Hilite button							
			$("#lz-infieldDiv").html(`<div class="lz-tip">${this.strings["discussIf"]}</div>`);			// Show tip
			}
		else if (phase == 2) {																			// DEAL 
			$("#lz-videoChat").remove(); 																// Remove old one
			this.DealCards();																			// Deal cards
			this.HourGlassTimer(this.time*this.speed, ()=>{ Sound("ding");  })							// Ding when time's up
			}
		else if ((phase > 2) && (phase < this.gs.players.length+3)) {									// EXPLAIN
			if (phase == 3) {																			// If 1st
				let i,v=[],picks=[];																	
				$("[id^=lz-cardCheck-]").each( function() {												// For each checkbox image	
					if ($(this).prop("src").match(/checked/)) 											// If checked
						if (v.length < 3)																// Less than 3
							v.push({time:$(this).data("timeStamp"), card:this.id.substring(13)-0 });	// Add card's index
					});		
				v.sort((a,b) => a.time-b.time);															// Sort by timeStamp
				for (i=0;i<v.length;++i) picks[i]=v[i].card;											// Simple array 
				this.ws.send("PICKS|"+this.gs.gameId+"|"+this.id+"|"+JSON.stringify(picks));			// Send picked cards to server
				}
			if (!redraw) this.VideoChat(this.gs.players[phase-3].name.split("@")[0]); 					// Open video with highlight
			this.ShowCards(this.gs.players[phase-3].picks,this.gs.players[phase-3].name);				// Show picked cards
			this.HourGlassTimer(this.time, ()=>{ Sound("ding"); });										// Done
			}
		else if (phase == this.gs.players.length+3) {													// DECIDE 
			if (!redraw) this.VideoChat("",30);															// Open smaller video chat	
			this.Decide();																				// Show all picked
			this.HourGlassTimer(this.time*this.speed, ()=>{ Sound("clicks");  })						// Clicks when time's up
			}
		else if (phase == this.gs.players.length+4) {													// DISCUSS
			if (!redraw) this.VideoChat();																// Open video chat	
			if (this.gs.winner != -1)																	// A winner picked
				this.ShowCards(this.gs.players[this.gs.winner].picks,"",`<div class="lz-tip">${this.strings["discuss"]}</div>`);	// Show tip
				this.DrawOutcome(this.gs.outcome);														// Show outcome																			
				this.round++;																			// Advance round
				app.Save();																				// Save to DB
				this.HourGlassTimer(this.time*this.speed, ()=>{ 										// Hourglass
					$("#lz-topbut").css("background-color","#27ae60"); 									// Hilite button							
					Sound("clicks"); 																	// Clicks
				});
			}
		this.Draw();																					// Redraw
	}

	DealCards()																						// DEAL CARDS
	{
		let i,num,str="";
		let x=0,y=0;																					// TLC
		let h=$("#lz-infieldDiv").height()/2.5;															// Card height
		let w=h*.75+12;																					// Width
		for (i=0;i<6;++i) {																				// For each card
			num=Math.floor(Math.random()*this.thens.length);											// Random index of thens
			str+=this.DrawCard(num,i,x,y,1,h);															// Add it
			x+=w;																						// Shift
			if (i == 2) x=0,y+=h+12;																	// New line
			}
		str+=`<div class="lz-tip">${this.strings["pickHand"]}</div>`;									// Add tip				
		$("#lz-infieldDiv").html(str.replace(/\t|\n|\r/g,""));											// Add it
		$("[id^=lz-cardDiv-]").removeClass("lz-hover");
		$("[id^=lz-cardDiv-]").on("mousedown", function(e) { if (!e.target.id.match(/cardCheck/)) $(this).css({"transform":"scale(2)","z-index":100})});
		$("[id^=lz-cardDiv-]").on("mouseup",  function() { $(this).css({"transform":"scale(1)","z-index":1})});
		
		$("[id^=lz-cardCheck-]").on("click", function(e) {												// ON CARD CHECKBOX CLICK 
			$(this).prop("src", $(this).prop("src").match(/checked/) ? "img/check.png" : "img/checked.png"); // Set box
			$(this).data('timeStamp',e.timeStamp);														// Add timeStamp
			Sound("click");																				// Click
			});	
	}

	ShowCards(cards, who="", tip)																	// SHOW PICKED CARDS
	{
		let i,y=0,str="";
		let x=$(window).width()/2+24;																	// Left
		let h=$(window).width()/2*.5625/3-10;															// Card height
		for (i=0;i<cards.length;++i) {																	// For each pick																
			str+=this.DrawCard(cards[i],0,x,y,0,h);														// Add card
			y+=h+12;
			}
		if (who == this.id) str+=`<div class="lz-tip">${this.strings["explainMyHand"]}</div>`;			// Add tip if it's me
		else if (who)		str+=`<div class="lz-tip">${who.split("@")[0]+this.strings["explainHand"]}</div>`;	// Someone else				
		else				str+=tip;																	// Just add tip															
		$("#lz-infieldDiv").html(str.replace(/\t|\n|\r/g,""));											// Add cards
	}

	Decide()																						// DECIDE
	{
		let i,j,o,x,y=0,str="";
		let h=Math.min(150,$("#lz-infieldDiv").height()/3-16);											// Card height
		let w=h*.75+8;																					// Width
		let winner=-1;																					// No decision yet
		for (i=0;i<this.gs.players.length;++i) {														// For each player
			x=$(window).width()*.3+12;																	// Reset x
			o=this.gs.players[i].picks;																	// Point at picks
			for (j=0;j<o.length;++j) {																	// For each card picked
				str+=this.DrawCard(o[j],(i*4)+j,x,y,0,h);												// Draw it
				x+=w;																					// Shift over
				}
			str+=`<div style="position:absolute;left:${x+12}px;top:${y+h/2-8}px">
			<img id="${"lz-voteCheck-"+i}" src="img/check.png" style="height:24px;vertical-align:-6px;cursor:pointer"></div>`;
			y+=h+16;																					// Next row
			}
		str+=`<div class="lz-tip">${this.strings["vote"]}</div>`;										// Show tip			
		$("#lz-infieldDiv").html(str.replace(/\t|\n|\r/g,""));											// Add cards
		
		$("[id^=lz-voteCheck-]").on("click", function() {												// ON CHECKBOX CLICK 
			$("[id^=lz-voteCheck-]").prop("src","img/check.png" );										// Turn all off
			$(this).prop("src", "img/checked.png");														// Highlight
			winner=this.id.substring(13)-0;																// Set winner
			app.ws.send("WINNER|"+app.gs.gameId+"|"+app.id+"|"+winner);									// Send winner to server
			Sound("click");
			});
	}

	HourGlassTimer(time, callback)																	// RUN HOURGLASS TIMER
	{
		let count=0;																					// Init seconds counter
		let reps=time*20;																				// Number of reps
		if (this.glassTimer) window.clearInterval(this.glassTimer);										// Stop timer
		this.glassTimer=window.setInterval( ()=>{														// Start seconds timer
			this.DrawHourGlass(count/reps);																// Draw hourglass
			if (count++ >= reps) {																		// Time's up
				window.clearInterval(this.glassTimer);													// Stop timer
				if (callback) callback();																// Run callback
				}
		},time*1000/reps);																				// time
	}

/////////////////////////////////////////////////////////////////////////////////////////////////
// DRAW 
/////////////////////////////////////////////////////////////////////////////////////////////////

	Draw(redraw)																					// DRAW GAME
	{
		let str=`<div style="display:inline-block;height:2.4vw;width:2.4vw;border-radius:100px;
			background-color:#27ae60;color:#fff;text-align:center">IF</div> &nbsp;`;
		$("#lz-ifDiv").html(this.gs.curIf != -1 ? str+this.ifs[this.gs.curIf] : "");					// Show if
		this.DrawStudents(this.gs.stuPos);																// Draw students
		this.DrawFlow();																				// Draw phase flow chart
		this.DrawClock(Math.floor(this.gs.curTime/60));													// Draw clock

		if (this.start == 1) {																			// INIT
			$("#lz-ifDiv").html(`<img src="img/smlogo.png" style="height:10vw">`);						// Add logo
			$("#lz-infieldDiv").html(this.strings["help"]);												// Start with help
			$("#lz-topbut").html("JOIN CHAT");															// Set button
			}
		else if (this.start == 2) {																		// IN LOBBY
			$("#lz-ifDiv").html(this.strings["lobby"]);													// Lobby welcome message
			$("#lz-topbut").html("START");																// Set button
			$("#lz-infieldDiv").html(`<div class="lz-tip">${this.strings["chatStart"]}</div>`);			// Show tip
			if (!redraw) this.VideoChat();																// Open video chat	
			}
	}

	VideoChat(focus="",pct=50)																		// OPEN VIDEO CHAT
	{
		$("#lz-videoChat").remove(); 																	// Remove old one
		let wid=$(window).width()*pct/100;																// Set height
		let hgt=wid*.5625;																				// Width
		let link="japp.htm?AgileGameChat"+("~"+app.gs.gameId).substring(8)+"&"+this.me+"&"+focus.toLowerCase();	// Make link
		if (window.location.host == "localhost")	link="";											// Debugging has no video
		let str=`<div id="lz-videoChat" style="position:absolute;background-color:#999;
			width:${wid}px;height:${hgt}px;top:11vw;left:calc(12.5% + 24px);display:block">
			<iframe style="width:100%;height:100%" src="${link}" 
			allow=camera;microphone;autoplay frameborder="0" allowfullscreen>
			</iframe>`;
		$("body").append(str.replace(/\t|\n|\r/g,""));													// Add it
	}

	DrawStudents(pos=[0,0,0,0,0,0,0,0,0,0])															// DRAW STUDENTS	
	{
		let i;
		let str=`<div style="position:absolute;top:11vw;width:12.5%;right:24px;height:calc(var(--maxvh) - 11vw - 18px);
			border-radius:8px;background-color:#eee;text-align:center;color:#333;border:1px solid #999;font-size:1vw;
			text-shadow:0 0 3px #fff, 0 0 3px #fff">
				<div style="position:absolute;top:1vw;width:70%;right:15%;border-bottom:1px solid #999"
					title="Students use their learning to pursue their own interests and further learning goals">LIBERTY</div>
				<div style="position:absolute;top:20%;width:70%;right:15%;border-bottom:1px solid #999"
					title="Students feel valued and are building relationships within the learning community">COMMUNITY</div>
				<div style="position:absolute;top:50%;width:82%;right:10%;border-bottom:1px solid #999"
					title="Students feel challenged and joy as they build skills, knowledge, and understanding">LEARNING</div>
				<div style="position:absolute;bottom:.5vw;width:100%;color:#666">STUDENT&nbsp;PROGRESS</div>
			
		<div style="display:grid;width:calc(100% - 32px);height:100%;padding:0 16px;grid-template-columns:1fr 1fr 1fr 1fr 1fr">`;
		for (i=0;i<this.stuCols.length;++i) {															// For each student
			pos[i]=Math.min(pos[i],9);	pos[i+5]=Math.min(pos[i+5],9);									// Cap 0-9
			str+=`<div style="margin-bottom:2.5vw;align-self:end">
				<div>	
					<div style="background-color:${this.stuCols[i]};border-radius:20px 20px 0 0;height:${(pos[i+5]-pos[i])*7.2}vh"></div>
					<div style="background-color:${this.stuCols[i]};opacity:.75;`;	
					if (!(pos[i]-pos[i+5]))	str+=`border-radius:20px 20px 0 0;`;					// Add curved top if same
						str+=`height:${Math.max(2,pos[i]*7.2)}vh"></div>
					</div>
			</div>`;
			}
		str+="</div></div>";	
		$("#lz-students").html(str.replace(/\t|\n|\r/g,""));											// Add dot
	}

	DrawTrack(pos)																					// DRAW STUDENT TRACK	
	{
		let i,sw=8;
		let left=$(window).width()/8+24;
		let fs=Math.max($(window).width()/128,10);														// Font size
		let bend=($(window).height()-48)*.3333;															// Corner size
		let w=($(window).width()-left-24-bend)															// Straight-away
		let bh=this.stuCols.length*(sw+2);																// Band height
		let str=`<text x="${w/2+left}" y="${24+bh+12}" letter-spacing="8" text-anchor="middle" fill="#666" font-size="${fs}">LEARNING</text>`;								
		str+=`<text x="${w+bend+left-bh-12}" y="${$(window).height()/2}" text-anchor="middle" style="writing-mode: tb;text-orientation:upright" fill="#666" font-size="${fs}">THRIVING</text>`;						
		str+=`<text x="${w/2+left-8}" y="${$(window).height()-24-bh}" letter-spacing="8" text-anchor="middle" fill="#666" font-size="${fs}">LIBERATING</text>`;						

		for (i=0;i<this.stuCols.length;++i) str+=drawBand(i,"#cccccc", 10);								// Gray base
		if (this.gs.stuPos)																				// If loaded
			for (i=0;i<this.stuCols.length;++i) str+=drawBand(i,this.stuCols[i],this.gs.stuPos[i] );	// Colored rings
		$("#lz-trackSVG").html(str);																	// Set SVG
		
		function drawBand(num, col, step) {																// DRAW STUDENT BAND
			bh=(num*(sw+2));																			// Line offset
			let y=24+bh;																				// Y pos
			let x=w/5*Math.min(step,5);																	// Position in straight-away
			let s=`<path style="fill:none;stroke:${col};stroke-width:${sw};
				stroke-linecap:round;stroke-linejoin:round"	d="M ${left} ${y} `;						// Start line
				s+=`L ${x+left} ${y} `;																	// Add straight-away
				if (step > 5)	s+=` a ${bend-bh} ${bend-bh} 0 0 1 ${bend-bh} ${bend-bh} `;				// Top curve
				if (step > 6)	s+=` l 0 ${bend} `;														// Middle 
				if (step > 7)	s+=` a ${-bend+bh} ${-bend+bh} 0 0 1 ${-bend+bh} ${bend-bh} `;			// Bottom curve
				if (step > 8)	s+=` l ${-w/2} 0 `;														// Add last leg 1
				if (step > 9)	s+=` l ${-w/2} 0 `;														// Add last leg 1
				s+=`"/>`;																				// Close line
				return s;																				// Close path and return band
			}
	}

	DrawFlow()																						// DRAW PHASE FLOW CHART
	{
		let i=1,j;
		let fh=Math.max($(window).width()/120,11);
		let y=$(window).height()-59;
		let str=`<div class="lz-bs" id="lz-topbut" style="font-size:${fh}px;margin-top:30px;
			background-color:${(this.gs.curPhase == 0) ? "#27ae60" : "#ccc"}">
			${(this.gs.curPhase == 1) ? "DEAL CARDS" : "&nbsp;PLAY&nbsp;"}</div><br><br><br>`;		
		str+=addItem(i++,"DISCUSS IF...")		 														// Add IF phase
		str+=addItem(i++,"PICK CARDS")																	// DEAL
			if (this.gs.players)
		for (j=0;j<this.gs.players.length;++j)															// For each player	
			str+=addItem(i++,this.gs.players[j].name.split("@")[0]+" TALKS");							// Add player's name
		str+=addItem(i++,"DECIDE");																		// DECIDE
		str+=addItem(i++,"DISCUSS")	;																	// DISCUSS
		str+=`<p><div class="lz-bs" id="lz-stats" style="font-size:${fh}px;background-color#27ae6">SCORE BOARD</div></p>`;
		$("#lz-flowDiv").html(str);																		// Add flowchart

		$("#lz-topbut").on("click", ()=>{ 																// ON TOP CLICK
			if (this.start == 1) { this.start=2; this.Draw(); return; }									// Start
			if (this.start == 2)  this.start=0; 														// Out of start sequence
			if ((this.gs.curPhase == 0) || (this.gs.curPhase == 4+this.gs.players.length))	this.ws.send("START|"+app.gs.gameId+"|"+app.id);	// New game	
			else if (this.gs.curPhase == 1) this.ws.send("DEAL|"+app.gs.gameId+"|"+app.id);				// Deal
			});										

		$("#lz-stats").on("click",()=> {															// ON STATS BUTTON
			if (!$("#lz-students").html())	this.Draw();												// If open, redraw
			else							this.DrawStats();											// Show stats				
			});
		
		function addItem(num, name) {																	// ADD PHASE/PLAYER TO MENU
			let col=(num == app.gs.curPhase) ? "#ea7f1d" : "#ccc";										// Hilite curPhase
			let s=`<p><div class="lz-bs" id="lz-phase-${num}" style="cursor:auto;font-size:${fh}px;background-color:${col}">${name.toUpperCase()}</div></p>`;
			return s;																					// Return item markup
			}
	}

	DrawCard(num, id, x, y, check, hgt)																// DRAW CARD
	{
		let o=this.thens[num];
		let i,cols=[];
		let pad=hgt/30;																					// Responsive padding
		cols["Structure"]="cyan"; 	cols["Help resource"]="magenta";	
		cols["Options"]="#d4dd46"; 	cols["Chance"]="#ccc";
		let title=o.title.split(" ").join("<br>")
		let oo=o.time;																					// Extract time field
		let str=`<div id="${"lz-cardDiv-"+id}" class="lz-card lz-hover" style="left:${x}px;top:${y}px;width:${hgt*.75}px;height:${hgt}px">
			<div style="grid-area:category;background-color:${cols[o.category]};font-size:${hgt/12.5}px;text-align:center;
				padding:0 0 2px 0;border-bottom:1px solid #999"><b>${o.category}</b>`;
			if (check)  str+=`<img id="${"lz-cardCheck-"+num}" src="img/check.png" style="float:left;height:2vh;margin:1vh 0 0 1vh;cursor:pointer">`;
			str+=`</div><div style="grid-area:title;padding:${pad}px;color:#666;font-size:${hgt/20}px"><b>${title.replace(/_/g," ")}</b></div>
			<div style="grid-area:subtitle;padding:0 ${pad}px;text-align:center;color:#000;font-size:${hgt/20}px"><b>${o.subtitle}</b></div>
			<div style="grid-area:desc;padding:0 ${pad}px;overflow:hidden;font-size:${hgt/26}px">${o.desc}</div>
			<div style="grid-area:time;padding:${pad}px;font-size:${hgt/18}px;text-align:center">
				<div style="width:${hgt/6}px;float:right;line-height:1;color:#666"><b>${oo.time}<br>mins</b></div>
			</div>
			<div style="grid-area:pic;text-align:center;padding-top:${pad}px">`;
				if (o.pic)	str+=`<img src="${o.pic}" style="width:${hgt/7}px">`;
			str+=`</div><div style="grid-area:students;padding-left:${pad}px;align-self:end">`;
			
			for (i=0;i<oo.students.length;++i)
				str+=`<div style="display:inline-block;background-color:${this.stuCols[oo.students[i]-1]};
				margin-right:3px;border-radius:25px;width:${hgt/15}px;height:${hgt/15}px"></div>`
			str+="</div></div>";
			return str;
	}

	DrawHourGlass(pct)																				// DRAW HOURGLASS
	{
		$("#lz-hourGlass").remove();																	// Remove old one
		let str=`<div id="lz-hourGlass" style="position:absolute;overflow:hidden;
			width:3vw;height:8vw;left:calc(87.5vw - 20px);top:18px">
			<img src="img/sandtop.png" style="position:absolute;width:100%;height:100%;top:${pct*40}%">
			<img src="img/hourtop.png" style="position:absolute;width:100%;height:100%">
			<img src="img/sandbot.png" style="position:absolute;width:100%;height:100%;top:${(1-pct)*40}%">
			<img src="img/hourglass.png" style="position:absolute;width:100%;height:100%"></div>`;
		$("body").append(str); 																			// Add to body
	}

	DrawOutcome(num)																				// SHOW OUTCOME
	{
		$("#lz-outcome").remove();																		// Kill old one
		let w=$(window).width()/12;																		// Width
		let t=w/10;																						// Line thickness
		let pos=[-45,0,45,90];																			// Angles
		let val=Math.min(Math.max(this.outcomes[num].category-0+1,0),3);								// Get val, convert -1 to +2  to 0 to -3
		pos=[pos[val]];																					// Get pos -45 to +90
		let col=["#b0263e","#666","#25aa54","#25aa54"];													// Text color
		col=[col[val]];																					// Get color based on value
		let str=`<div id="lz-outcome" 
			style="position:absolute;overflow:hidden;left:(12.5vw + 24px);top:calc(28vw + 12px);width:50vw;text-align:center;color:${col}">
			<svg width="12vw" height="6vw">
				<path fill="none" stroke="#b0263e" stroke-width="${t}" d="${arc(w/2+t*2,w/2+t,w/2,-90,0)}"/>
				<path fill="none" stroke="#25aa54" stroke-width="${t}" d="${arc(w/2+t*2,w/2+t,w/2,0,90)}"/>`;
				str+=`<line stroke-linecap="round" x1="49%" y1="${t*2.3}" x2="49%" y2="${w/2+t/2}" transform="rotate(${pos})"
				style="stroke:#999;stroke-width:${t};transform-origin:50% 80%;"
		</svg>`;	
		str+=`<div style="vertical-align:top;margin-left:12px"><b>${this.outcomes[num].title}</b></div></div>`;
		$("#lz-infieldDiv").append(str);

		function polarToCartesian(cx, cy, r, angleInDegrees) {											// GET ARC
			let a=(angleInDegrees-90)*Math.PI/180.0;
			return { x:cx+r*Math.cos(a), y:cy+r*Math.sin(a) };
			}

		function arc(x, y, r, startAngle, endAngle) {
			let start = polarToCartesian(x, y, r, endAngle);
			let end = polarToCartesian(x, y, r, startAngle);
			let largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
			let d=[ "M", start.x, start.y, "A", r, r, 0, largeArcFlag, 0, end.x, end.y ].join(" ");
			return d;    
			}		
		}

	DrawClock(mins, tot=45)																			// DRAW CLOCK
	{
		let i,x1,y1,col;
		let rad=$(window).width()/24;																	// Radius based on wifth
		let step=(2*Math.PI)/tot;																		// Dot step
		let ang=-Math.PI/2;																				// Start straight up
		$("#lz-clockSVG").remove();																		// Remove old one
		let str=`<svg id="lz-clockSVG" width="${rad*2+6}" height="${rad*2+6}" style="position:absolute;right:24px;top:12px">`;
		for	(i=0;i<tot;++i) {																			// For each mark
			x1= rad+4+rad*Math.cos(ang);																// Calc x
			y1= rad+4+rad*Math.sin(ang);																// Y
			ang+=step;																					// Next angle
			col=(i <= mins) ? "#25aa54" : "#cccccc";													// Set color
			str+=`<circle cx="${x1}" cy="${y1}" r="3" fill="${col}" />`;								// Draw dot
			}
		str+=`<text x="${rad+3}" y="${rad*1.2}" text-anchor="middle" fill="#25aa54" font-size="${rad}">${tot-mins}</text>`;		// Number						
		str+=`<text x="${rad+3}" y="${rad*1.55}" text-anchor="middle" fill="#999" font-size="${rad/4}">minutes left</text>`; 		// Label						
		str+=`<text x="${rad+3}" y="${rad*1.75}" text-anchor="middle" fill="#999" font-size="${rad/4}">in class</text></svg>`; 	// Label						
		$("#mainDiv").append(str); 
	}

/////////////////////////////////////////////////////////////////////////////////////////////////
// SOCKET 
/////////////////////////////////////////////////////////////////////////////////////////////////

	InitSocketServer()																				// INIT SOCKET SERVER
	{
		this.secs=0;																					// Time
		this.retryWS=false;																				// Reconnecting to web socket
		this.ws=new WebSocket(((window.location.host == "localhost") ?'ws' : 'wss')+'://'+window.location.host+':8085');	// Open  websocket											
		this.ws.onmessage=(e)=>{ this.SocketIn(e); };													// ON INCOMING MESSAGE
		this.ws.onclose=()=>   { console.log('disconnected'); this.ws=null; this.retryWS=true; Sound("delete") };			// ON CLOSE
		this.ws.onerror=(e)=>  { console.log('error',e);	};											// ON ERROR
		this.ws.onopen=()=> { 																			// ON OPEN	
			console.log('connected'); 																	// Show connected
			this.ws.send("INIT|"+this.me+"|"+this.me);													// Init																	
			this.pollTimer= window.setInterval( ()=>{													// INIT POLLING SERVER
			++this.secs;																				// Another second 
			if (this.retryWS) {																			// If reconnecting to websocket
				this.ws=new WebSocket(((window.location.host == "localhost") ?'ws' : 'wss')+'://'+window.location.host+':8085');	// Open  websocket											
				this.ws.onmessage=(e)=>{ this.SocketIn(e); };											// ON INCOMING MESSAGE
				this.ws.onclose=()=>   { this.retryWS=true; console.log('disconnected'); };				// ON CLOSE
				this.ws.onopen=()=>    { console.log('re-connected'); };								// ON OPEN  
				this.retryWS=false;																		// Not retrying	anymore
				}
			},1000)
		}
	}

	SocketIn(event)																					// A WEBSOCKET MESSAGE FROM NODE WS SERVER
	{
		trace(event.data);
		if (!event.data)			 return;															// Quit if no data
		let v=event.data.split("|");																	// Get params
		this.gs=JSON.parse(v[3]);																		// Get game state
		if (v[0] == "INIT")			{ this.id=this.me+"@"+v[1]; this.Draw(); }							// INIT and get IP
		else if (v[0] == "START") 	this.SetPhase(1);													// START
		else if (v[0] == "DRAW")  	this.Draw();														// DRAW 
		else if (v[0] == "PICKS")  	this.ShowCards(this.gs.players[this.gs.curPhase-3].picks,this.gs.players[this.gs.curPhase-3].name);	// PICKED
		else if (v[0] == "NEXT")  	this.SetPhase(this.gs.curPhase);									// NEXT 
		else if (v[0] == "OVER")  	this.SetPhase(100);													// OVER 
		else if (v[0] == "VOTED") 	this.SetPhase(this.gs.curPhase);									// DECIDED
	}

	DrawStats()																						//	DRAW GAME STATS
	{
		let gd=[];
		let rounds=[];
		let gameId=this.gs.gameId;
gameId="1668977192";

		$("#lz-infieldDiv").html("");																	// Clear infield
		$("#lz-students").html("");																		// Clear student
		$("#lz-videoChat").remove(); 																	// Remove video
		$("#lz-clockSVG").remove();																		// Remove cClock
		$("#lz-ifDiv").html(" <img src='img/smlogo.png' width='64' style='vertical-align:-8px'/>&nbsp;&nbsp; AGILITY GAME SCORE BOARD");
		let str=`<div style="margin-top:-43px">
			<div id="lzstab-0" class="lz-tab">This game</div>
			<div id="lzstab-1" class="lz-tab">My games</div>
			<div id="lzstab-2" class="lz-tab">All games</div>
			</div>
			<div id='lzstatsDiv' style="width:100%;border:1px solid #999;background-color:#eee;
				border-top:none; border-radius:6px; border-top-left-radius:0;padding:12px;
				overflow-y:auto;overflow:x:hidden;height:calc(var(--maxvh) - 11vw - 36px)"
			</div>`;
	
		$("#lz-infieldDiv").html(str.replace(/\t|\n|\r/g,""));											// Add it
		$("[id^=lzstab-]").on("click",function(e) {	drawPage($(this)[0].id.substring(7));	});			// ON TAB CLICK
		
		fetch(`//${window.location.host}:8081?q=loadall&a=b&type=AG`)									// Fetch history
			.then(res => res.json()).then(data => {														// Process
				let i;
				for (i=0;i<data.length;++i)	{															// For each round
					gd[i]=JSON.parse(data[i].data); 													// Extract game data as an obj
					gd[i].playerId=data[i].email;														// Get player name+ip
					}
				drawPage(0);																			// Draw this game stats
			})										
	
		function drawPage(num) {																		// DRAW STATS PAGE
			
			let i,str="";
			let h=80,w=h*.75+12;
			$("[id^=lzstab-]").css({"background-color":"#fff","font-weight":"normal",color:"#999"});	// Reset all
			$("#lzstab-"+num).css({"background-color":"#eee","font-weight":"bold",color:"#27ae60"});	// Set current one
			if (num == 0) {																				// If this game
				for (i=0;i<gd.length;++i)																// For each round
					if ((gd[i].gameId == gameId) && (gd[i].playerId == app.id)) rounds.push(gd[i]);		// If this game and my entry, add to list 
				rounds.sort((a,b) => b.curTime-a.curTime);												// Sort by newest first
				str=`</div><div style="display:flex">
					<div style="font-size:12px;padding-top:24px;text-align:right;width:100px;padding-right:12px">Student<br>progress</div>`;
				for (i=rounds.length-1;i>=0;--i) {														// For each round
					str+=`<div style="position:relative;width:${w}px;height:${h+12}px">`;				// Container div			
					str+=drawProgress(0,0,h,rounds[i].stuPos);											// Draw progress in time order
					str+="</div>";																		// Close container
					}
				str+="</div><hr>";																		// End section
				for (i=0;i<rounds.length;++i) str+=drawRound(i);										// Draw each round
trace(rounds)
				}
			else if (num == 1) {																		// My games
				str="My games data will be displayed";
				}
			else if (num == 2) {																		// All games
				str="<All games data will be displayed";
				}
			$("#lzstatsDiv").html(str.replace(/\t|\n|\r/g,""));											// Draw
			}

		function drawProgress(x, y, h, pos) {															// DRAW STUDENT PROGRESS
			let i;
			let str=`<div style="position:absolute;top:${y}px;width:${h*.75}px;left:${x}px;height:${h}px;
					display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr">`;
			for (i=0;i<app.stuCols.length;++i) {														// For each student
				pos[i]=Math.min(pos[i],9);	pos[i+5]=Math.min(pos[i+5],9);								// Cap 0-9
				str+=`<div style="align-self:end">
					<div style="background-color:${app.stuCols[i]};border-radius:6px 6px 0 0;height:${(pos[i+5]-pos[i])*h/10}px"></div>
					<div style="background-color:${app.stuCols[i]};opacity:.75;`;	
				if (!(pos[i]-pos[i+5]))	str+=`border-radius:6px 6px 0 0;`;								// Add curved top if same
				str+=`height:${Math.max(2,pos[i]*h/10)}px"></div></div>`;
				}
			return(str+"</div>");
			}

		function drawRound(num) {																		// DRAW ROUND
			let i,j,k;
			let h=80,w=h*.75+12;
			let o=rounds[num];																			// Point at round
			str=`<p><div style="display:flex">
				<div style="width:100px"><b>ROUND ${o.round}</b></div><i><div>${app.ifs[o.curIf]}</i></div></p>
				</div><div style="display:flex">
					<div style="font-size:12px;padding-top:24px;text-align:right;width:100px;padding-right:12px">Cards played <br>by everyone</div>`;
			for (j=0;j<o.players.length;++j) 													// For each player
				for (k=0;k<o.players[j].picks.length;++k) 										// For each pick
					str+=`<div style="position:relative;width:${w}px;height:${h+12}px">${app.DrawCard(o.players[j].picks[k],0,0,0,0,h)}</div>`;
			k=0;
			for (j=0;j<o.players.length;++j) 													// For each player
				if (o.players[j].name == app.id) { k=j; break; } 								// If it's me
				str+=`</div><div style="display:flex">
				<div style="font-size:12px;padding-top:24px;text-align:right;width:100px;padding-right:12px">Cards played<br>by me</div>`;
			for (j=0;j<o.players[k].picks.length;++j) 											// For each pick
				str+=`<div style="position:relative;width:${w}px;height:${h+12}px">${app.DrawCard(o.players[k].picks[j],0,0,0,0,h)}</div>`;
			str+=`<div style="font-size:12px;padding-top:24px;text-align:center;width:${50}px;padding-right:12px">Winning<br>cards</div>`;
			for (j=0;j<o.players[o.winner].picks.length;++j) 									// For each winner
				str+=`<div style="position:relative;width:${w}px;height:${h+12}px">${app.DrawCard(o.players[o.winner].picks[j],0,0,0,0,h)}</div>`;
			str+=`</div><div style="display:flex">
				<div style="font-size:12px;padding-top:24px;text-align:right;width:100px;padding-right:12px">Student<br>progress</div>`;
			for (i=rounds.length-1;i>=num;--i) {
				str+=`<div style="position:relative;width:${w}px;height:${h+12}px">`;
				str+=drawProgress(0,0,h,rounds[i].stuPos);
				str+="</div>";
				}
			str+="</div><hr>";
			return str;
		}

	}

} // CLASS CLOSURE

/////////////////////////////////////////////////////////////////////////////////////////////////
// HELPERS 
/////////////////////////////////////////////////////////////////////////////////////////////////

	function trace(msg, p1, p2, p3, p4)																// CONSOLE 
	{
		if (p4 != undefined)
			console.log(msg,p1,p2,p3,p4);
		else if (p3 != undefined)
			console.log(msg,p1,p2,p3);
		else if (p2 != undefined)
			console.log(msg,p1,p2);
		else if (p1 != undefined)
			console.log(msg,p1);
		else
			console.log(msg);
	}

	function Sound(sound, mute)																		// PLAY SOUND
	{
		var snd=new Audio();																			// Init audio object
		if (sound.match(/\.mp3/i))		snd=new Audio(sound)											// If an MP3 file
		else							snd=new Audio("img/"+sound+".mp3");								// Use built in mp3
		if (!mute)	{																					// If not initing or muting	
			snd.volume=100/100;																			// Set volume
			snd.play();																					// Play it
			}
		}

	function PopUp(msg, time, div)																	// TIMED POPUP
	{
		var str="";
		$("#popupDiv").remove();																		// Kill old one, if any
		str+="<div id='popupDiv' class='lz-popup'>"; 													// Add div
		if (time == -1) {																				// If has close but
			time=100000;																				// Increase time
			str+="<img id='pu-close' src='img/closedot.gif' style='float:right;cursor:pointer'>";		// Add close button
			}
		str+=msg+"</div>"; 																				// Add div
		$(div ? "#"+div : "body").append(str);															// Add popup to div or body
		$("#pu-close").click(function() { $("#popupDiv").remove(); });									// Remove on click of close but
		$("#popupDiv").fadeIn(500).delay(time ? time*1000 : 3000).fadeOut(500);							// Animate in and out		
	}

	function GetTextBox(title, content, def, callback)											// GET TEXT LINE BOX
	{
		$("#confirmBoxDiv").remove();																	// Remove 
		$("body").append("<div class='lz-confirm' id='confirmBoxDiv'></div>");							// Add box								
		var str="<img src='img/smlogo.png' width='64' style='vertical-align:-8px'/>&nbsp;&nbsp;";								
		str+="<span style='font-size:14px; color:#666'><b>"+title+"</b></span><br><br>";
		str+="<p>"+content+"<p>";
		str+="<p><input class='lz-is' style='width:75%' type='text' id='gtBoxTt' value='"+def+"'></p>";
		str+="<div id='dialogOK' class='lz-bs'>OK</div>";
		str+="<div id='dialogCancel' class='lz-bs' style='margin-left:8px;background-color:#999'>Cancel</div></div>";
		$("#confirmBoxDiv").html(str);																	// Add to div
		$("#gtBoxTt").focus();																			// Focus on button
		$("#gtBoxTt").on("change", function() {	callback($("#gtBoxTt").val()); $("#confirmBoxDiv").remove(); });	// ONE ENTER
		$("#dialogOK").on("click", function() {	callback($("#gtBoxTt").val()); $("#confirmBoxDiv").remove(); });	// ON OK 
		$("#dialogCancel").on("click", function() {	$("#confirmBoxDiv").remove(); });								// ON CANCEL
		}

	function TimecodeToSeconds(timecode) 														// CONVERT TIMECODE TO MILLISECONDS
	{
		if (!timecode)	return 0;
		let t=0;
		let v=timecode.match(/(\d*):(\d*):(\d*)\.*(\d*)/);											// Parse
		t+=v[2]*60*1000;																			// Get mins
		t+=v[3]*1000;																				// Get secs
		if (v[4]) t+=v[4]/1000;																		// Ms
		return t;																					// Return time in ms
	}

	function LoadingIcon(mode)																	// SHOW/HIDE LOADING ICON		
	{
		if (!mode) {																				// If hiding
			$("#lz-loadingIcon").remove();															// Remove it
			return;																					// Quit
			}
		let str="<div id='lz-loadingIcon' style='position:absolute;top:calc(50% - 64px);left:calc(50% - 64px);z-index:5000;text-align:center'>";
		str+="<img src='img/loading.gif' width='128'>";												// Img
		str+="<div id='lz-loadingIconText' style='margin-top:-78px;color:#999'></div></div>";		// Progress
		$("body").append(str);																		// Add icon to container
	}

	function SaveTextAsFile(file, contents)														// SAVE TEXT TO LOCAL FILE
	{
		if (file.charAt(0) == "*") {																// If asking
			GetTextBox("Type file name","", file.substr(1), (s)=>{ SaveTextAsFile(s, contents); });	// Ask for name
			return;																					// Quit
			}
		var textFileAsBlob=new Blob([contents], {type:'text/plain'});
		var downloadLink=document.createElement("a");
		downloadLink.download=file;
		downloadLink.innerHTML="Download File";
		downloadLink.href=window.URL.createObjectURL(textFileAsBlob);
	    downloadLink.onclick=()=>{ downloadLink.remove(); };
		downloadLink.style.display="none";
		downloadLink.id="tdll";
		document.body.appendChild(downloadLink);
		downloadLink.click();
	}


</script>
</body>
</html>



